/* main.c
 *
 *  Created on: August 20, 2016
 *      Author: Joest
 */


#include "RBELib/RBELib.h"
//For use of abs()
#include <stdlib.h>

//character for receiving serial data
char inchar;

#define BIT(n) (1 << (n))

void writeMotor0(int pwr);
void writeMotor1(int pwr);

volatile long timerCount = 0;
char str[10];
/*
 * 0: waiting for start bit
 * 1: receiving command code
 * 2-10: receiving packets
 */
volatile int readState = 0;
volatile int readData = 0;
/*
 * 1:drive top link
 * 2:drive bottom link
 */
volatile int command = 0;

volatile int driveVal0;
volatile int driveVal1;


int main(void)
{
	  //Enable printf() and setServo()
	  initRBELib();
	  sei();

	  // Write the USARTDebug.c file using the function prototypes in the H file to enable the usart
	  //Set the baud rate of the UART
	  debugUSARTInit(230400);
	  initSPI();

	  writeMotor0(0);
	  writeMotor1(0);
	  //wait to start
	  setServo(1,0);
	  inchar = getCharDebug();

//	  initTimer(2,CTC,180); //100 Hz Timer
	  while(1){
	  }
}

ISR(TIMER2_COMPA_vect){
	timerCount++;

	int lowerADC = getADC(3);
	int upperADC = getADC(2);
	printf("%f,%f\r\n",((double)lowerADC/1024.0)*240-58,((double)upperADC/1024.0)*240-150);
	for(int i = 0;i<10;i++){
		char tmp = getCharDebug();
		if(tmp == '\n'){
			break;
		}else{
			str[i] = tmp;
		}
	}
	int driveVal0 = atoi(str);

	writeMotor0(driveVal0);
//	writeMotor1(driveVal1);

}

ISR(USART1_RX_vect){
	unsigned char val = getCharDebug();
	switch(readState){
	case 0:
		if(val==0x01){
			readState++;
		}
		break;
	case 1:
		command = val;
		readState++;
		break;
	default:
		if(val=='\n'){
			readState = 0;
			switch(command){
			case 1:
				driveVal0 = readData;
			}
		}else{
			readData +=(val<<(8*(readState-2)));
		}
	}
}

void writeMotor0(int pwr){
	if(pwr>4095)pwr = 4095;
	if(pwr<-4095)pwr = -4095;
	if(pwr>0){
	  setDAC(1,0);
	  setDAC(0,pwr);
	}else{
	  setDAC(0,0);
	  setDAC(1,-pwr);
	}
}

void writeMotor1(int pwr){
	if(pwr>4095)pwr = 4095;
	if(pwr<-4095)pwr = -4095;
	if(pwr>0){
	  setDAC(2,0);
	  setDAC(3,pwr);
	}else{
	  setDAC(3,0);
	  setDAC(2,-pwr);
	}
}
